name: Push (Main)
on:
  push:
jobs:
  docker-build-and-push-main:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Build and Publish Docker
      uses: ./.github/actions/build-and-publish-docker-image
      with:
        image_name: 'tier2-publication-node' # Replace with your image name
        image_tag: ${{ github.sha }}
        dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ip: ${{fromJson(steps.setup-matrix.outputs.ip_list)}}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
      - name: Prepare IP List
        id: setup-matrix
        run: |
          # Convert comma-separated list to JSON array
          IP_JSON=$(echo '${{ secrets.EC2_INSTANCES }}' | jq -R 'split(",")')
          echo "::set-output name=ip_list::$IP_JSON"
      - name: Deploy to ec2
        uses: ./.github/actions/deploy-ec2
        with:
          ec2_host: ${{ matrix.ip }}
          ec2_ssh_private_key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}